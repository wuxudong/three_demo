<!--suppress ALL -->
<html>

<head>

    <script src="lib/three.js"></script>
    <script src="lib/Box2D_v2.3.1_min.js"></script>
    <script src="lib/TrackBallControls.js"></script>


</head>
<body>
<div id="container">


    <script>

        Box2D().then(function (Box2D) {
          var camera = undefined,
            scene = undefined,
            renderer = undefined,
            light = undefined,
            plane = undefined,
            ball = undefined,
            ballRadius = 0.5,
            ironTexture = THREE.ImageUtils.loadTexture('/ball.png');


          var wWorld = undefined;
          var wBall = undefined;

          var controls = undefined;

          function createRenderWorld() {
            // Create the scene object.
            scene = new THREE.Scene();

            // Add the light.
            // 创建场景Scene
            // 添加环境光
            // 添加方向光
            var light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 0, 100);
            light.castShadow = true;
            light.shadowDarkness = 0.5;
            light.name = "light"

            scene.add(light);


            // 地面形状
            // 生成地面
            plane = new THREE.Mesh(new THREE.PlaneBufferGeometry(5, 5, 1, 1), new THREE.MeshLambertMaterial({color: 0xffff00}));
            plane.position.set(0, 0, 0);
            plane.name = "plane"
//        plane.rotation.x = -Math.PI / 4;
            plane.receiveShadow = true;
            plane.material.side = THREE.DoubleSide;
            scene.add(plane);

            // Add the ball.
            ball = new THREE.Mesh(new THREE.SphereGeometry(ballRadius, 64, 64), new THREE.MeshPhongMaterial({map: ironTexture}));
            ball.position.set(0, 0, 1);
            ball.name = "ball"
            ball.castShadow = true
            scene.add(ball);

            // Add the camera.
            var aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(60, aspect, 1, 1000);
            camera.position.set(0, 0, 5);
            camera.lookAt(new THREE.Vector3(3, 3, -2));
            scene.add(camera);


            controls = new THREE.TrackballControls(camera);
          }

          function createPhysicsWorld() {
            wWorld = new Box2D.b2World(new Box2D.b2Vec2(0.0, -10.0));




            var ground = wWorld.CreateBody(new Box2D.b2BodyDef());

            var shape0 = new Box2D.b2EdgeShape();
            shape0.Set(new Box2D.b2Vec2(-40.0, -6.0), new Box2D.b2Vec2(40.0, -6.0));
            ground.CreateFixture(shape0, 0.0);




            // Create the ball.
            var bodyDef = new Box2D.b2BodyDef();
            bodyDef.type = Box2D.b2Body.b2_dynamicBody;

            bodyDef.set_position(1, 1);
            wBall = wWorld.CreateBody(bodyDef);
            wBall.CreateFixture(new Box2D.b2CircleShape(ballRadius), 0.0);

          }

          function updatePhysicsWorld() {
            wWorld.Step(1 / 60, 8, 3);
          }

          function updateRenderWorld() {
            var stepX = wBall.GetPosition().x - ball.position.x;
            var stepY = wBall.GetPosition().y - ball.position.y;
            ball.position.x += stepX;
            ball.position.y += stepY;
          }

          function gameLoop() {

            updatePhysicsWorld();
            updateRenderWorld();

            controls.update();
            renderer.render(scene, camera);

            requestAnimationFrame(gameLoop);

          }




          renderer = new THREE.WebGLRenderer({antialias: true, logarithmicDepthBuffer: true});
          // 设置渲染器参数
          renderer.setClearColor(0xf0f0f0);
          renderer.setSize(window.innerWidth, window.innerHeight);

          renderer.shadowMapEnabled = true;
          renderer.shadowMapSoft = true;

          renderer.shadowCameraNear = 1;
          renderer.shadowCameraFar = 1000;
          renderer.shadowCameraFov = 50;

          renderer.shadowMapBias = 0.0039;
          renderer.shadowMapDarkness = 0.5;
          renderer.shadowMapWidth = 1024;
          renderer.shadowMapHeight = 1024;

          document.body.appendChild(renderer.domElement);

          createPhysicsWorld();
          createRenderWorld();
          gameLoop()

        })

    </script>
</div>


</body>
</html>